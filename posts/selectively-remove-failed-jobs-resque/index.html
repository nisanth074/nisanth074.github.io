<html>
  <head>
  <title>Nisanth's Blog</title>
  <link rel="shortcut icon" href="/favicon-a409055.ico">

  
  <link rel="stylesheet" href="https://nisanth074.github.io//css/vendor/fonts.css">

  
  <link rel="stylesheet" href="https://nisanth074.github.io//css/vendor/lemonade.css">
  <link rel="stylesheet" href="https://nisanth074.github.io//bower_components/normalize.css/normalize.css">

  <link rel="stylesheet" href="https://nisanth074.github.io//css/lemonade-custom.css">
  <link rel="stylesheet" href="https://nisanth074.github.io//css/reset.css">
  <link rel="stylesheet" href="https://nisanth074.github.io//css/main.css">
  <link rel="stylesheet" href="https://nisanth074.github.io//css/animations.css">

  
  <link rel="stylesheet" href="https://nisanth074.github.io//css/pygments-github.css">
</head>


  <body>
    <div class="frame">
  <div class="header">
    <div class="avatar-container bit-50">
      <a href="https://nisanth074.github.io/">
        <img src="https://nisanth074.github.io//images/avatar.jpeg" class="avatar"></img>
      </a>
    </div>
    <nav class="top-nav bit-50">
      <ul>
        <li><a href="/library">Library</a></li>
        <li><a href="/about">About</a></li>
      </ul>
    </nav>
  </div>
</div>


    <div class="main frame">
  <div class="page fade-in-up">

      <div class="post">
        <h1 class="post-title">Selectively remove failed jobs from Resque 1.x</h1>
        <p class="post-date">May 12, 2014</p>


        <div class="post-content"><p>Copy the code snippet below and paste it in a rails console.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">delete_if</span>
  <span class="n">redis</span> <span class="o">=</span> <span class="no">Resque</span><span class="o">.</span><span class="n">redis</span>

  <span class="p">(</span><span class="mi">0</span><span class="o">...</span><span class="no">Resque</span><span class="o">::</span><span class="no">Failure</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">lindex</span><span class="p">(</span><span class="ss">:failed</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">break</span> <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">nil?</span>

    <span class="n">job</span> <span class="o">=</span> <span class="no">Resque</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">remove</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">job</span>
    <span class="k">next</span> <span class="k">unless</span> <span class="n">remove</span>

    <span class="n">redis</span><span class="o">.</span><span class="n">lrem</span><span class="p">(</span><span class="ss">:failed</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
    <span class="k">redo</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>


<p>To selectively delete a subset of failed jobs, say we wish delete all push notification jobs that have failed because of http errors, run</p>

<p><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">delete_if</span> <span class="k">do</span> <span class="o">|</span><span class="n">job</span><span class="o">|</span>
  <span class="n">job</span><span class="o">[</span><span class="s1">&#39;payload&#39;</span><span class="o">][</span><span class="s1">&#39;class&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;SendPushNotification&#39;</span> <span class="o">&amp;&amp;</span>
    <span class="n">job</span><span class="o">[</span><span class="s1">&#39;exception&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;Pusher::HTTPError&#39;</span>
<span class="k">end</span>
</code></pre></div>
</p>

<p>in the console.</p>
</div>
      </div>
      </div>
</div>

    

<script src="https://nisanth074.github.io//js/twitterWidgets.js"></script>

  </body>
</html>
